generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum ReleaseStatus {
  COMPLETE
  INCOMPLETE
  EXTRA_TRACKS
  MISSING
  UNSYNCABLE
  UNKNOWN
}

enum TrackArtistRole {
  PRIMARY
  ALBUM_ARTIST
  FEATURED
}

// ---------------------------------------------------------------------------
// Artist
// ---------------------------------------------------------------------------

model Artist {
  id                String               @id @default(cuid())
  name              String
  slug              String               @unique
  image             String?
  imageUrl          String?              @db.Text
  musicbrainzId     String?
  averageMatchScore Float?
  totalPlayCount    Int                  @default(0)
  totalTracks       Int                  @default(0)
  totalFileSize     BigInt               @default(0)
  lastSyncedAt      DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  urls              ArtistUrl[]          @relation("ArtistUrls")
  localReleases     LocalRelease[]       @relation("ArtistLocalReleases")
  mbReleases        MusicBrainzRelease[] @relation("ArtistMbReleases")
  genres            Genre[]              @relation("ArtistGenres")
  trackArtists      TrackArtist[]        @relation("ArtistTracks")

  @@index([musicbrainzId])
}

// ---------------------------------------------------------------------------
// ArtistUrl
// ---------------------------------------------------------------------------

model ArtistUrl {
  id        String   @id @default(cuid())
  type      String
  url       String
  artistId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  artist    Artist   @relation("ArtistUrls", fields: [artistId], references: [id], onDelete: Cascade)

  @@unique([artistId, type, url])
  @@index([artistId])
}

// ---------------------------------------------------------------------------
// Genre
// ---------------------------------------------------------------------------

model Genre {
  id       String               @id @default(cuid())
  name     String               @unique
  artists  Artist[]             @relation("ArtistGenres")
  releases MusicBrainzRelease[] @relation("ReleaseGenres")

  @@index([name])
}

// ---------------------------------------------------------------------------
// ReleaseType
// ---------------------------------------------------------------------------

model ReleaseType {
  id        String               @id @default(cuid())
  name      String               @unique
  slug      String               @unique
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  mbReleases MusicBrainzRelease[]
}

// ---------------------------------------------------------------------------
// MusicBrainzRelease
// ---------------------------------------------------------------------------

model MusicBrainzRelease {
  id             String                  @id @default(cuid())
  title          String                  @db.VarChar(500)
  artistId       String
  typeId         String
  year           Int?
  musicbrainzId  String?
  status         ReleaseStatus           @default(UNKNOWN)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  favorite       FavoriteRelease?
  localReleases  LocalRelease[]
  artist         Artist                  @relation("ArtistMbReleases", fields: [artistId], references: [id], onDelete: Cascade)
  type           ReleaseType             @relation(fields: [typeId], references: [id])
  genres         Genre[]                 @relation("ReleaseGenres")
  tracks         MusicBrainzReleaseTrack[]

  @@unique([artistId, title])
  @@index([typeId])
  @@index([musicbrainzId])
  @@map("musicbrainz_releases")
}

// ---------------------------------------------------------------------------
// MusicBrainzReleaseTrack
// ---------------------------------------------------------------------------

model MusicBrainzReleaseTrack {
  id              String              @id @default(cuid())
  title           String              @db.VarChar(500)
  position        Int?
  discNumber      Int?
  durationMs      Int?
  musicbrainzId   String?
  releaseId       String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  release         MusicBrainzRelease  @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  localTracks     LocalReleaseTrack[]

  @@index([releaseId])
  @@index([musicbrainzId])
  @@map("musicbrainz_release_tracks")
}

// ---------------------------------------------------------------------------
// LocalRelease
// ---------------------------------------------------------------------------

model LocalRelease {
  id              String              @id @default(cuid())
  title           String              @db.VarChar(500)
  year            Int?
  artistId        String
  releaseId       String?
  matchStatus     ReleaseStatus       @default(UNKNOWN)
  forcedComplete  Boolean             @default(false)
  folderPath      String?             @db.Text
  image           String?
  imageUrl        String?             @db.Text
  totalPlayCount  Int                 @default(0)
  totalDuration   Int?                @default(0)
  totalFileSize   BigInt              @default(0)
  lastPlayedAt    DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  artist          Artist              @relation("ArtistLocalReleases", fields: [artistId], references: [id], onDelete: Cascade)
  release         MusicBrainzRelease? @relation(fields: [releaseId], references: [id])
  tracks          LocalReleaseTrack[]

  @@unique([artistId, title])
  @@index([releaseId])
}

// ---------------------------------------------------------------------------
// LocalReleaseTrack
// ---------------------------------------------------------------------------

model LocalReleaseTrack {
  id             String                   @id @default(cuid())
  title          String?                  @db.Text
  artist         String?                  @db.Text
  albumArtist    String?                  @db.Text
  album          String?                  @db.Text
  year           Int?
  genre          String?                  @db.Text
  duration       Int?
  bitrate        Int?
  sampleRate     Int?
  filePath       String                   @unique @db.VarChar(500)
  position       String?                  @db.Text
  trackNumber    Int?
  discNumber     Int?
  localReleaseId String?
  mbTrackId      String?
  fileSize       BigInt?
  mtime          DateTime?
  contentHash    String?                  @db.VarChar(32)
  metadata       Json?
  playCount      Int                      @default(0)
  lastPlayedAt   DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  localRelease   LocalRelease?            @relation(fields: [localReleaseId], references: [id], onDelete: Cascade)
  mbTrack        MusicBrainzReleaseTrack? @relation(fields: [mbTrackId], references: [id])
  favorite       FavoriteTrack?
  playlistTracks PlaylistTrack[]
  trackArtists   TrackArtist[]            @relation("TrackArtists")

  @@index([localReleaseId])
  @@index([mbTrackId])
  @@index([lastPlayedAt])
  @@index([contentHash])
  @@index([mtime])
}

// ---------------------------------------------------------------------------
// TrackArtist
// ---------------------------------------------------------------------------

model TrackArtist {
  id        String            @id @default(cuid())
  trackId   String
  artistId  String
  role      TrackArtistRole   @default(PRIMARY)
  createdAt DateTime          @default(now())
  track     LocalReleaseTrack @relation("TrackArtists", fields: [trackId], references: [id], onDelete: Cascade)
  artist    Artist            @relation("ArtistTracks", fields: [artistId], references: [id], onDelete: Cascade)

  @@unique([trackId, artistId, role])
  @@index([trackId])
  @@index([artistId])
}

// ---------------------------------------------------------------------------
// Playlist
// ---------------------------------------------------------------------------

model Playlist {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  description String?         @db.Text
  image       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  tracks      PlaylistTrack[]
}

model PlaylistTrack {
  id         String            @id @default(cuid())
  position   Int
  playlistId String
  trackId    String
  createdAt  DateTime          @default(now())
  playlist   Playlist          @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  track      LocalReleaseTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([playlistId, trackId])
  @@index([playlistId])
  @@index([trackId])
}

// ---------------------------------------------------------------------------
// Favorites
// ---------------------------------------------------------------------------

model FavoriteRelease {
  id        String             @id @default(cuid())
  releaseId String             @unique
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  release   MusicBrainzRelease @relation(fields: [releaseId], references: [id], onDelete: Cascade)

  @@index([releaseId])
}

model FavoriteTrack {
  id        String            @id @default(cuid())
  trackId   String            @unique
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  track     LocalReleaseTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@index([trackId])
}

// ---------------------------------------------------------------------------
// Settings & Statistics
// ---------------------------------------------------------------------------

model SearchSource {
  id            String   @id @default(cuid())
  name          String   @unique
  baseUrl       String
  queryTemplate String
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Settings {
  id                String   @id @default("main")
  slskPath          String?
  slskUsername      String?
  slskPassword      String?
  slskDownloadDir   String?
  slskAllowedFormats String?
  slskMinBitrate    Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Statistics {
  id                                  String    @id @default("main")
  artists                             Int       @default(0)
  playtime                            BigInt    @default(0)
  plays                               BigInt    @default(0)
  tracks                              Int       @default(0)
  releases                            Int       @default(0)
  genres                              Int       @default(0)
  artistsSyncedWithMusicbrainz        Int       @default(0)
  releasesSyncedWithMusicbrainz       Int       @default(0)
  artistsWithCoverArt                 Int       @default(0)
  releasesWithCoverArt                Int       @default(0)
  lastScanStartedAt                   DateTime?
  lastScanEndedAt                     DateTime?
  createdAt                           DateTime  @default(now())
  updatedAt                           DateTime  @updatedAt
}

// ---------------------------------------------------------------------------
// IndexCheckpoint (for resume functionality)
// ---------------------------------------------------------------------------

model IndexCheckpoint {
  id              String   @id @default("main")
  lastFolder      String?  @db.Text
  filesProcessed  Int      @default(0)
  musicDir        String?  @db.Text
  filterFrom      String?
  filterTo        String?
  filterOnly      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ---------------------------------------------------------------------------
// S3DeletionQueue (for cleanup of deleted images)
// ---------------------------------------------------------------------------

model S3DeletionQueue {
  id         String   @id @default(cuid())
  objectKey  String
  createdAt  DateTime @default(now())

  @@index([createdAt])
}
